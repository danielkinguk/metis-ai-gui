<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metis GUI - AI Security Code Review</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Metis Security Code Review</h1>
            <p class="subtitle">AI-Powered Security Analysis Tool</p>
            <div id="status-indicator" class="status">
                <span class="status-dot"></span>
                <span class="status-text">Checking configuration...</span>
                <button class="btn btn-small btn-config" onclick="openConfigModal()">‚öôÔ∏è Configure API</button>
            </div>
        </header>

        <div class="config-panel">
            <h3>Configuration</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label for="codebase-path">Codebase Path:</label>
                    <div class="path-input-group">
                        <input type="text" id="codebase-path" value="." placeholder="Path to your codebase">
                        <button class="btn btn-small" onclick="openFolderBrowser()">üìÅ Browse</button>
                    </div>
                </div>
                <div class="config-item">
                    <label for="language">Language Plugin:</label>
                    <select id="language">
                        <option value="c">C</option>
                        <option value="python">Python</option>
                        <option value="rust">Rust</option>
                    </select>
                </div>
                <div class="config-item">
                    <label for="backend">Vector Backend:</label>
                    <select id="backend">
                        <option value="chroma">ChromaDB</option>
                        <option value="postgres">PostgreSQL</option>
                    </select>
                </div>
                <div class="config-item">
                    <label for="project-schema">Project Schema:</label>
                    <input type="text" id="project-schema" value="myproject-main" placeholder="Schema name">
                </div>
                <div class="config-item" id="chroma-config">
                    <label for="chroma-dir">ChromaDB Directory:</label>
                    <input type="text" id="chroma-dir" value="./chromadb" placeholder="ChromaDB storage path">
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'index-tab')">Index</button>
            <button class="tab-button" onclick="openTab(event, 'ask-tab')">Ask</button>
            <button class="tab-button" onclick="openTab(event, 'review-patch-tab')">Review Patch</button>
            <button class="tab-button" onclick="openTab(event, 'review-file-tab')">Review File</button>
            <button class="tab-button" onclick="openTab(event, 'review-code-tab')">Review Code</button>
            <button class="tab-button" onclick="openTab(event, 'update-tab')">Update Index</button>
        </div>

        <div id="index-tab" class="tab-content active">
            <h2>Index Codebase</h2>
            <p>Build the vector database index for your codebase. This is required before performing reviews or asking questions.</p>
            <button class="btn btn-primary" onclick="indexCodebase()">Start Indexing</button>
            <div class="progress-bar" id="index-progress" style="display: none;">
                <div class="progress-fill"></div>
            </div>
        </div>

        <div id="ask-tab" class="tab-content">
            <h2>Ask Questions</h2>
            <p>Ask security-related questions about your codebase.</p>
            <textarea id="question" rows="4" placeholder="Enter your question here..."></textarea>
            <button class="btn btn-primary" onclick="askQuestion()">Ask</button>
        </div>

        <div id="review-patch-tab" class="tab-content">
            <h2>Review Patch</h2>
            <p>Upload a patch file to review for security issues.</p>
            <div class="file-upload">
                <input type="file" id="patch-file" accept=".patch,.diff,.txt">
                <label for="patch-file" class="file-label">Choose patch file...</label>
                <span id="patch-filename"></span>
            </div>
            <button class="btn btn-primary" onclick="reviewPatch()">Review Patch</button>
        </div>

        <div id="review-file-tab" class="tab-content">
            <h2>Review File</h2>
            <p>Review a specific file in your codebase for security issues.</p>
            <input type="text" id="file-path" placeholder="Enter file path (e.g., src/main.c)">
            <button class="btn btn-primary" onclick="reviewFile()">Review File</button>
        </div>

        <div id="review-code-tab" class="tab-content">
            <h2>Review Entire Codebase</h2>
            <p>Perform a comprehensive security review of your entire codebase.</p>
            <button class="btn btn-primary" onclick="reviewCode()">Start Full Review</button>
            <div class="warning">
                <strong>‚ö†Ô∏è Note:</strong> Full codebase review may take considerable time depending on the size of your project.
            </div>
        </div>

        <div id="update-tab" class="tab-content">
            <h2>Update Index</h2>
            <p>Update the vector database index with changes from a patch file.</p>
            <div class="file-upload">
                <input type="file" id="update-patch-file" accept=".patch,.diff,.txt">
                <label for="update-patch-file" class="file-label">Choose patch file...</label>
                <span id="update-patch-filename"></span>
            </div>
            <button class="btn btn-primary" onclick="updateIndex()">Update Index</button>
        </div>

        <div class="results-panel" id="results" style="display: none;">
            <h3>Results</h3>
            <div class="result-actions">
                <button class="btn btn-small" onclick="clearResults()">Clear</button>
                <button class="btn btn-small" id="download-btn" style="display: none;" onclick="downloadResults()">Download JSON</button>
            </div>
            <div id="result-content"></div>
        </div>

        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p>Processing request...</p>
        </div>

        <!-- API Configuration Modal -->
        <div id="config-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>API Configuration</h2>
                    <button class="close-btn" onclick="closeConfigModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="modal-description">Configure your API keys for Metis. Keys are stored locally and used for all operations.</p>
                    
                    <div class="api-section">
                        <h3>OpenAI Configuration</h3>
                        <div class="config-item">
                            <label for="openai-key">OpenAI API Key:</label>
                            <div class="key-input-group">
                                <input type="password" id="openai-key" placeholder="sk-..." autocomplete="off">
                                <button class="btn btn-small" onclick="toggleKeyVisibility('openai-key')">üëÅÔ∏è</button>
                            </div>
                            <small>Get your key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></small>
                        </div>
                    </div>

                    <div class="api-section">
                        <h3>Azure OpenAI Configuration (Optional)</h3>
                        <div class="config-item">
                            <label for="azure-key">Azure OpenAI API Key:</label>
                            <div class="key-input-group">
                                <input type="password" id="azure-key" placeholder="Your Azure OpenAI key" autocomplete="off">
                                <button class="btn btn-small" onclick="toggleKeyVisibility('azure-key')">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="config-item">
                            <label for="azure-endpoint">Azure Endpoint:</label>
                            <input type="text" id="azure-endpoint" placeholder="https://your-resource.openai.azure.com/">
                        </div>
                        <div class="config-item">
                            <label for="azure-deployment">Azure Deployment Name:</label>
                            <input type="text" id="azure-deployment" placeholder="your-deployment-name">
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="saveApiConfig()">Save Configuration</button>
                        <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
                        <button class="btn btn-danger" onclick="clearApiConfig()">Clear All Keys</button>
                    </div>

                    <div id="config-message" class="config-message" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Folder Browser Modal -->
        <div id="folder-browser-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÅ Select Code Folder</h2>
                    <button class="close-btn" onclick="closeFolderBrowser()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="browser-header">
                        <div class="path-navigation">
                            <button class="btn btn-small" onclick="navigateToParent()" id="parent-btn">üìÅ Up</button>
                            <button class="btn btn-small" onclick="navigateToHome()">üè† Home</button>
                            <span class="current-path" id="current-path">/</span>
                        </div>
                    </div>
                    
                    <div class="browser-content" id="browser-content">
                        <div class="loading-spinner">Loading directories...</div>
                    </div>
                    
                    <div class="browser-footer">
                        <div class="selected-path">
                            <strong>Selected:</strong> <span id="selected-path">None</span>
                        </div>
                        <div class="browser-actions">
                            <button class="btn btn-primary" onclick="selectCurrentFolder()" id="select-btn" disabled>Select This Folder</button>
                            <button class="btn btn-secondary" onclick="closeFolderBrowser()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>